pipeline {
  agent none
  options { skipDefaultCheckout(true) }

  stages {
    stage('Checkout') {
      agent { label 'agen1' }
      steps {
        checkout scm
        stash name: 'src', includes: '**/*', useDefaultExcludes: false
      }
    }

    // (Optionnel) Pré-chauffer le repo Maven et le partager
    stage('Prewarm Maven cache') {
      agent { label 'agen1' }
      steps {
        unstash 'src'
        sh '''
          MVN_REPO="$WORKSPACE/.m2"
          mvn -B -Dmaven.repo.local="$MVN_REPO" -q -DskipTests dependency:go-offline
        '''
        stash name: 'm2-cache', includes: '.m2/**', useDefaultExcludes: false
      }
    }

    stage('Builds en parallèle') {
      parallel {
        stage('Build API (agen1)') {
          agent { label 'agen1' }
          steps {
            unstash 'src'
            unstash 'm2-cache'
            sh '''
              MVN_REPO="$WORKSPACE/.m2"
              mvn -B -Dmaven.repo.local="$MVN_REPO" -pl api -am -DskipTests verify
            '''
          }
        }
        stage('Build Service (agen2)') {
          agent { label 'agen2' }
          steps {
            unstash 'src'
            unstash 'm2-cache'
            sh '''
              MVN_REPO="$WORKSPACE/.m2"
              mvn -B -Dmaven.repo.local="$MVN_REPO" -pl service -am -U verify
            '''
          }
        }
      }
    }
  }
}
