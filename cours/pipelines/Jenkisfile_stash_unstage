pipeline {
  agent none

  options { skipDefaultCheckout(true) }

  stages {
    stage('Checkout') {
      agent { label 'agen1' }
      steps {
        checkout scm
        stash name: 'src', includes: '**/*', useDefaultExcludes: false
      }
    }

    stage('Build API (agent1)') {
      agent { label 'agen1' }
      steps {
        unstash 'src'
        sh '''
          # repo maven local dans le workspace (portable entre agents)
          MVN_REPO="$WORKSPACE/.m2"
          mvn -B -Dmaven.repo.local="$MVN_REPO" -pl api -am -DskipTests install

          # stasher le cache maven local + artefacts utiles
          # (le cache contient le SNAPSHOT installé)
        '''
        stash name: 'm2-cache', includes: '.m2/**', useDefaultExcludes: false
        stash name: 'api-artifacts', includes: 'api/target/*.jar', allowEmpty: true
      }
    }

    stage('Build Service (agent2)') {
      agent { label 'agen2' }
      steps {
        unstash 'src'
        unstash 'm2-cache'
        // (optionnel) unstash 'api-artifacts' si tu en as besoin
        sh '''
          MVN_REPO="$WORKSPACE/.m2"
          # -U si tu veux forcer la MàJ des snapshots en plus du cache transféré
          mvn -B -Dmaven.repo.local="$MVN_REPO" -pl service -am -U verify
        '''
      }
    }
  }

  post {
    always {
      // Nettoyage léger si besoin
      echo 'Done.'
    }
  }
}
